---
import ImageUpload from '../components/ImageUpload.astro';
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Upload Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
      }
      h1 {
        color: #2d3748;
        margin-bottom: 2rem;
      }
      .demo-section {
        margin-bottom: 3rem;
      }
      .uploaded-images {
        margin-top: 2rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }
      .image-card {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.5rem;
      }
      .image-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 4px;
      }
      .image-info {
        font-size: 0.75rem;
        color: #718096;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <h1>Image Upload Demo</h1>

    <div class="demo-section">
      <h2>Upload an Image</h2>
      <ImageUpload folder="demo" onUploadComplete="handleUploadComplete" />
    </div>

    <div class="demo-section">
      <h2>Uploaded Images</h2>
      <div id="uploadedImages" class="uploaded-images"></div>
    </div>

    <script>
      // Handle upload complete callback
      window.handleUploadComplete = function(result) {
        console.log('Upload complete:', result);
        addImageToGallery(result);
      };

      // Also listen for the custom event
      document.getElementById('uploadArea')?.addEventListener('imageUploaded', (e) => {
        console.log('Image uploaded event:', e.detail);
      });

      function addImageToGallery(result) {
        const gallery = document.getElementById('uploadedImages');
        const card = document.createElement('div');
        card.className = 'image-card';

        const img = document.createElement('img');
        img.src = result.url;
        img.alt = 'Uploaded image';

        const info = document.createElement('div');
        info.className = 'image-info';
        info.innerHTML = `
          <div>Size: ${formatBytes(result.size)}</div>
          <div>Type: ${result.contentType}</div>
        `;

        card.appendChild(img);
        card.appendChild(info);
        gallery.insertBefore(card, gallery.firstChild);
      }

      function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
      }

      // Load existing images on page load
      async function loadImages() {
        try {
          const response = await fetch('/api/images?folder=demo&limit=20');
          if (response.ok) {
            const data = await response.json();
            data.blobs.forEach(blob => {
              addImageToGallery({
                url: blob.url,
                size: blob.size,
                contentType: 'image/*'
              });
            });
          }
        } catch (error) {
          console.error('Failed to load images:', error);
        }
      }

      loadImages();
    </script>
  </body>
</html>
